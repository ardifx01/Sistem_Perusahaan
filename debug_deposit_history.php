<?php\n\n/*\n * SCRIPT DEBUG DEPOSIT HISTORY\n * Gunakan script ini untuk menganalisis masalah deposit dengan keterangan penambahan/pengurangan\n * \n * Cara pakai:\n * 1. Buka php artisan tinker\n * 2. Copy paste script ini\n * 3. Ganti $customerId dengan ID customer yang bermasalah\n */\n\n// Ganti dengan customer ID yang bermasalah\n$customerId = 1; // GANTI SESUAI KEBUTUHAN\n\n$customer = \\App\\Models\\User::find($customerId);\n\nif (!$customer) {\n    echo \"Customer tidak ditemukan!\\n\";\n    exit;\n}\n\necho \"=== DEBUG DEPOSIT HISTORY ===\\n\";\necho \"Customer: {$customer->name}\\n\";\necho \"Total Deposit (Database): Rp \" . number_format($customer->total_deposit, 2) . \"\\n\";\necho \"Total Purchases (Database): Rp \" . number_format($customer->total_purchases, 2) . \"\\n\";\necho \"Current Balance: Rp \" . number_format($customer->getCurrentBalance(), 2) . \"\\n\\n\";\n\n// Analisis deposit history\n$depositHistory = is_string($customer->deposit_history) \n    ? json_decode($customer->deposit_history, true) \n    : ($customer->deposit_history ?? []);\n\nif (empty($depositHistory)) {\n    echo \"Tidak ada riwayat deposit.\\n\";\n    exit;\n}\n\necho \"=== RIWAYAT DEPOSIT DETAIL ===\\n\";\n$totalPenambahan = 0;\n$totalPengurangan = 0;\n$totalCalculated = 0;\n\nforeach ($depositHistory as $index => $deposit) {\n    $date = $deposit['date'] ?? 'N/A';\n    $amount = floatval($deposit['amount'] ?? 0);\n    $keterangan = $deposit['keterangan'] ?? 'penambahan';\n    $deskripsi = $deposit['deskripsi'] ?? ($deposit['description'] ?? '-');\n    \n    echo \"#{$index}: \";\n    echo \"Tanggal: {$date} | \";\n    echo \"Amount: Rp \" . number_format($amount, 2) . \" | \";\n    echo \"Keterangan: {$keterangan} | \";\n    echo \"Deskripsi: {$deskripsi}\\n\";\n    \n    // Hitung berdasarkan keterangan\n    if ($keterangan === 'pengurangan') {\n        $totalPengurangan += abs($amount);\n        $totalCalculated -= abs($amount);\n    } else {\n        $totalPenambahan += $amount;\n        $totalCalculated += $amount;\n    }\n}\n\necho \"\\n=== RINGKASAN PERHITUNGAN ===\\n\";\necho \"Total Penambahan: Rp \" . number_format($totalPenambahan, 2) . \"\\n\";\necho \"Total Pengurangan: Rp \" . number_format($totalPengurangan, 2) . \"\\n\";\necho \"Total Calculated: Rp \" . number_format($totalCalculated, 2) . \"\\n\";\necho \"Total Database: Rp \" . number_format($customer->total_deposit, 2) . \"\\n\";\necho \"Selisih: Rp \" . number_format($totalCalculated - $customer->total_deposit, 2) . \"\\n\\n\";\n\n// Analisis per periode\necho \"=== ANALISIS PER PERIODE ===\\n\";\n$periodeSummary = [];\n\nforeach ($depositHistory as $deposit) {\n    if (isset($deposit['date'])) {\n        $date = \\Carbon\\Carbon::parse($deposit['date']);\n        $periode = $date->format('Y-m');\n        $amount = floatval($deposit['amount'] ?? 0);\n        $keterangan = $deposit['keterangan'] ?? 'penambahan';\n        \n        if (!isset($periodeSummary[$periode])) {\n            $periodeSummary[$periode] = [\n                'penambahan' => 0,\n                'pengurangan' => 0,\n                'net' => 0\n            ];\n        }\n        \n        if ($keterangan === 'pengurangan') {\n            $periodeSummary[$periode]['pengurangan'] += abs($amount);\n            $periodeSummary[$periode]['net'] -= abs($amount);\n        } else {\n            $periodeSummary[$periode]['penambahan'] += $amount;\n            $periodeSummary[$periode]['net'] += $amount;\n        }\n    }\n}\n\n// Sort by periode\nksort($periodeSummary);\n\nforeach ($periodeSummary as $periode => $summary) {\n    echo \"Periode {$periode}:\\n\";\n    echo \"  Penambahan: Rp \" . number_format($summary['penambahan'], 2) . \"\\n\";\n    echo \"  Pengurangan: Rp \" . number_format($summary['pengurangan'], 2) . \"\\n\";\n    echo \"  Net: Rp \" . number_format($summary['net'], 2) . \"\\n\\n\";\n}\n\necho \"=== REKOMENDASI ===\\n\";\nif (abs($totalCalculated - $customer->total_deposit) > 0.01) {\n    echo \"⚠️  Ada ketidaksesuaian antara calculated dan database!\\n\";\n    echo \"💡 Pertimbangkan untuk melakukan rekalkulasi total_deposit\\n\";\n} else {\n    echo \"✅ Data deposit konsisten dengan database\\n\";\n}\n\necho \"\\n=== SELESAI ===\\n\";\n